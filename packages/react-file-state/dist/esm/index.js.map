{"version":3,"sources":["../../src/create-store.ts","../../src/utils/is-equal.ts","../../src/utils/mutate.ts","../../src/utils/pick.ts"],"sourcesContent":["import { useCallback, useEffect, useRef, useState } from \"react\";\nimport type { JsonArray, JsonObject, JsonPrimitive } from \"type-fest\";\nimport { isEqual } from './utils/is-equal';\n\ntype Data = JsonObject | JsonArray | JsonPrimitive;\ntype State = { [k: string]: Data; };\ntype DerivedState = { [k: string]: Data; };\ntype Actions = { [k: string]: (...args: any[]) => void; };\n\nexport const createStore = <S extends State, D extends DerivedState, A extends Actions>\n  (\n    initialState: S,\n    derivedStateResolver: (s: S) => D,\n    actionsCreator: (\n      get: () => S,\n      set: (newState: S) => void,\n      set2: (stateMutator: (prevState: S) => S) => void\n    ) => A\n  ) => {\n  let state = initialState;\n  let derivedState = derivedStateResolver(initialState);\n  let listeners: (() => void)[] = [];\n  const get = () => state;\n  const getDerived = () => derivedState;\n  const getWithDerived = () => ({ ...state, ...derivedState });\n  const set = (newState: S) => {\n    state = newState;\n    derivedState = derivedStateResolver(newState);\n    listeners.forEach((x) => x());\n  };\n  const set2 = (stateMutator: (prev: S) => S) => {\n    const prev = get();\n    const newState = stateMutator(prev);\n    state = newState;\n    derivedState = derivedStateResolver(newState);\n    listeners.forEach((x) => x());\n  };\n  const actions = actionsCreator(get, set, set2);\n  const subscribe = (func: () => void) => {\n    listeners.push(func);\n    return () => {\n      listeners = listeners.filter(x => x !== func);\n    };\n  };\n\n  type Selector<U> = (ms: S & D) => U;\n  const defaultSelector = (ms: S & D) => ms as any;\n  const useStore = <U>(selector: Selector<U> = defaultSelector) => {\n    const selectorMemoized = useCallback(selector, []);\n    const lastState = useRef(selectorMemoized(getWithDerived()));\n    const [state, setState] = useState(selectorMemoized(getWithDerived()));\n    useEffect(() => {\n      const unsubscribe = subscribe(() => {\n        const newState = selectorMemoized(getWithDerived());\n        if (!isEqual(newState, lastState.current)) {\n          setState(newState);\n          lastState.current = newState;\n        }\n      });\n      return () => unsubscribe();\n    }, [selectorMemoized]);\n\n    return [state, actions] as const;\n  };\n  return {\n    get,\n    getDerived,\n    getWithDerived,\n    set,\n    subscribe,\n    actions,\n    useStore\n  };\n};\n\n","export const isEqual = <T>(a: T, b: T) => {\n  if (Object.is(a, b)) return true;\n  return JSON.stringify(a) === JSON.stringify(b);\n};\n","export const mutate = <A,>(a: A, massager: (a: A) => void): A => {\n  // clone\n  const clone: A = JSON.parse(JSON.stringify(a));\n  // let consumer massage it\n  // (inside massager you must mutate directly)\n  massager(clone);\n  // update persistent storage\n  //editorStateStorage.save(clone);\n  // return\n  return clone;\n};","export const pick = <T, U extends keyof T>(object: T, keys: U[]): Pick<T, U> => {\n  return keys.reduce(\n    (out, key) => ({ ...out, [key]: object[key] }),\n    {} as Pick<T, U>\n  );\n};\n"],"mappings":";AAAA,SAAS,aAAa,WAAW,QAAQ,gBAAgB;;;ACAlD,IAAM,UAAU,CAAI,GAAM,MAAS;AACxC,MAAI,OAAO,GAAG,GAAG,CAAC;AAAG,WAAO;AAC5B,SAAO,KAAK,UAAU,CAAC,MAAM,KAAK,UAAU,CAAC;AAC/C;;;ADMO,IAAM,cAAc,CAEvB,cACA,sBACA,mBAKG;AACL,MAAI,QAAQ;AACZ,MAAI,eAAe,qBAAqB,YAAY;AACpD,MAAI,YAA4B,CAAC;AACjC,QAAM,MAAM,MAAM;AAClB,QAAM,aAAa,MAAM;AACzB,QAAM,iBAAiB,OAAO,EAAE,GAAG,OAAO,GAAG,aAAa;AAC1D,QAAM,MAAM,CAAC,aAAgB;AAC3B,YAAQ;AACR,mBAAe,qBAAqB,QAAQ;AAC5C,cAAU,QAAQ,CAAC,MAAM,EAAE,CAAC;AAAA,EAC9B;AACA,QAAM,OAAO,CAAC,iBAAiC;AAC7C,UAAM,OAAO,IAAI;AACjB,UAAM,WAAW,aAAa,IAAI;AAClC,YAAQ;AACR,mBAAe,qBAAqB,QAAQ;AAC5C,cAAU,QAAQ,CAAC,MAAM,EAAE,CAAC;AAAA,EAC9B;AACA,QAAM,UAAU,eAAe,KAAK,KAAK,IAAI;AAC7C,QAAM,YAAY,CAAC,SAAqB;AACtC,cAAU,KAAK,IAAI;AACnB,WAAO,MAAM;AACX,kBAAY,UAAU,OAAO,OAAK,MAAM,IAAI;AAAA,IAC9C;AAAA,EACF;AAGA,QAAM,kBAAkB,CAAC,OAAc;AACvC,QAAM,WAAW,CAAI,WAAwB,oBAAoB;AAC/D,UAAM,mBAAmB,YAAY,UAAU,CAAC,CAAC;AACjD,UAAM,YAAY,OAAO,iBAAiB,eAAe,CAAC,CAAC;AAC3D,UAAM,CAACA,QAAO,QAAQ,IAAI,SAAS,iBAAiB,eAAe,CAAC,CAAC;AACrE,cAAU,MAAM;AACd,YAAM,cAAc,UAAU,MAAM;AAClC,cAAM,WAAW,iBAAiB,eAAe,CAAC;AAClD,YAAI,CAAC,QAAQ,UAAU,UAAU,OAAO,GAAG;AACzC,mBAAS,QAAQ;AACjB,oBAAU,UAAU;AAAA,QACtB;AAAA,MACF,CAAC;AACD,aAAO,MAAM,YAAY;AAAA,IAC3B,GAAG,CAAC,gBAAgB,CAAC;AAErB,WAAO,CAACA,QAAO,OAAO;AAAA,EACxB;AACA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;;;AEzEO,IAAM,SAAS,CAAK,GAAM,aAAgC;AAE/D,QAAM,QAAW,KAAK,MAAM,KAAK,UAAU,CAAC,CAAC;AAG7C,WAAS,KAAK;AAId,SAAO;AACT;;;ACVO,IAAM,OAAO,CAAuB,QAAW,SAA0B;AAC9E,SAAO,KAAK;AAAA,IACV,CAAC,KAAK,SAAS,EAAE,GAAG,KAAK,CAAC,MAAM,OAAO,KAAK;AAAA,IAC5C,CAAC;AAAA,EACH;AACF;","names":["state"]}