{"version":3,"sources":["../../src/create-store.ts"],"sourcesContent":["import { useCallback, useEffect, useRef, useState } from \"react\";\nimport type { JsonArray, JsonObject, JsonPrimitive } from \"type-fest\";\ntype GetParameters<F> = F extends (...args: any) => any ? Parameters<F> : never;\ntype RemoveFirstArrayItem<T extends any[]> = ((...p: T) => void) extends ((p1: infer P1, ...rest: infer R) => void) ? R : never;\n\ntype Data = JsonObject | JsonArray | JsonPrimitive;\ntype State = { [k: string]: Data; };\ntype DerivedState = { [k: string]: Data; };\ntype Actions<S> = {\n  [k: string]: (prevState: S, ...args: any[]) => S;\n};\ntype ActionsProxied<A extends Actions<any>> = Record<\n  keyof A,\n  (...args: RemoveFirstArrayItem<GetParameters<A[keyof A]>>) => void\n>;\n\n\n\nconst stateAreEquals = (a: any, b: any) => {\n  return JSON.stringify(a) === JSON.stringify(b);\n};\n\n\nconst buildActionsProxied = <S extends State, A extends Actions<S>>(\n  actions: A,\n  get: () => S,\n  set: (newState: S) => void\n): ActionsProxied<A> => {\n  const actionsProxied = {} as ActionsProxied<A>;\n  for (let [key, value] of Object.entries(actions)) {\n    const actionProvided = value;\n    const actionProxied = (...args: any[]) => {\n      const prevState = get();\n      const newState = actionProvided(prevState, ...args);\n      set(newState);\n    };\n    const keyTyped: keyof A = key;\n    actionsProxied[keyTyped] = actionProxied;\n  }\n  return actionsProxied;\n};\n\n\n\nexport const createStore = <\n  S extends State,\n  D extends DerivedState,\n  A extends Actions<S>>\n  (\n    initialState: S,\n    derivedStateResolver: (s: S) => D,\n    actions: A\n  ) => {\n  let state = initialState;\n  let derivedState = derivedStateResolver(initialState);\n  const listeners: (() => void)[] = [];\n  const get = () => state;\n  const getWithDerived = () => ({ ...state, ...derivedState });\n  const set = (newState: S) => {\n    state = newState;\n    derivedState = derivedStateResolver(newState);\n    listeners.forEach((x) => x());\n  };\n  const actionsProxied = buildActionsProxied(actions, get, set);\n  const subscribe = (func: () => void) => {\n    listeners.push(func);\n    return () => {\n      listeners.splice(listeners.length - 1);\n    };\n  };\n\n  type Selector = (ms: S & D) => Partial<S & D>;\n  const useStore = (selector: Selector = (ms) => ms) => {\n    const selectorMemoized = useCallback(selector, []);\n    const lastState = useRef(selectorMemoized(getWithDerived()));\n    const [state, setState] = useState(selectorMemoized(getWithDerived()));\n    useEffect(() => {\n      const unsubscribe = subscribe(() => {\n        const newState = selectorMemoized(getWithDerived());\n        if (!stateAreEquals(newState, lastState.current)) {\n          setState(newState);\n          lastState.current = newState;\n        }\n      });\n      return () => unsubscribe();\n    }, [selectorMemoized]);\n\n    return [state, actionsProxied] as const;\n  };\n  return {\n    get,\n    set,\n    subscribe,\n    actions,\n    actionsProxied,\n    useStore\n  };\n};\n\n"],"mappings":";AAAA,SAAS,aAAa,WAAW,QAAQ,gBAAgB;AAkBzD,IAAM,iBAAiB,CAAC,GAAQ,MAAW;AACzC,SAAO,KAAK,UAAU,CAAC,MAAM,KAAK,UAAU,CAAC;AAC/C;AAGA,IAAM,sBAAsB,CAC1B,SACA,KACA,QACsB;AACtB,QAAM,iBAAiB,CAAC;AACxB,WAAS,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,OAAO,GAAG;AAChD,UAAM,iBAAiB;AACvB,UAAM,gBAAgB,IAAI,SAAgB;AACxC,YAAM,YAAY,IAAI;AACtB,YAAM,WAAW,eAAe,WAAW,GAAG,IAAI;AAClD,UAAI,QAAQ;AAAA,IACd;AACA,UAAM,WAAoB;AAC1B,mBAAe,YAAY;AAAA,EAC7B;AACA,SAAO;AACT;AAIO,IAAM,cAAc,CAKvB,cACA,sBACA,YACG;AACL,MAAI,QAAQ;AACZ,MAAI,eAAe,qBAAqB,YAAY;AACpD,QAAM,YAA4B,CAAC;AACnC,QAAM,MAAM,MAAM;AAClB,QAAM,iBAAiB,OAAO,EAAE,GAAG,OAAO,GAAG,aAAa;AAC1D,QAAM,MAAM,CAAC,aAAgB;AAC3B,YAAQ;AACR,mBAAe,qBAAqB,QAAQ;AAC5C,cAAU,QAAQ,CAAC,MAAM,EAAE,CAAC;AAAA,EAC9B;AACA,QAAM,iBAAiB,oBAAoB,SAAS,KAAK,GAAG;AAC5D,QAAM,YAAY,CAAC,SAAqB;AACtC,cAAU,KAAK,IAAI;AACnB,WAAO,MAAM;AACX,gBAAU,OAAO,UAAU,SAAS,CAAC;AAAA,IACvC;AAAA,EACF;AAGA,QAAM,WAAW,CAAC,WAAqB,CAAC,OAAO,OAAO;AACpD,UAAM,mBAAmB,YAAY,UAAU,CAAC,CAAC;AACjD,UAAM,YAAY,OAAO,iBAAiB,eAAe,CAAC,CAAC;AAC3D,UAAM,CAACA,QAAO,QAAQ,IAAI,SAAS,iBAAiB,eAAe,CAAC,CAAC;AACrE,cAAU,MAAM;AACd,YAAM,cAAc,UAAU,MAAM;AAClC,cAAM,WAAW,iBAAiB,eAAe,CAAC;AAClD,YAAI,CAAC,eAAe,UAAU,UAAU,OAAO,GAAG;AAChD,mBAAS,QAAQ;AACjB,oBAAU,UAAU;AAAA,QACtB;AAAA,MACF,CAAC;AACD,aAAO,MAAM,YAAY;AAAA,IAC3B,GAAG,CAAC,gBAAgB,CAAC;AAErB,WAAO,CAACA,QAAO,cAAc;AAAA,EAC/B;AACA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;","names":["state"]}